<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manage · Zzzの图标库</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/manage.css') }}?v=manage_20260104">
</head>

<body class="m-body">
  <div class="m-bg" id="mBg"></div>
  <div class="m-overlay"></div>

  <main class="m-wrap">
    <header class="m-top">
      <div class="m-brand">
        <div class="m-logo">✦</div>
        <div>
          <div class="m-title">管理后台</div>
          <div class="m-sub">PICUI 图片管理 · 同步 icons.json</div>
        </div>
      </div>
      <div class="m-actions">
        <a class="m-link" target="_blank" href="{{ gist_raw }}">打开 icons.json</a>
        <a class="m-link" href="/editor">去编辑页</a>
        <button class="m-btn ghost" id="btnBg">换背景</button>
      </div>
    </header>

    <section class="m-card" id="loginCard">
      <div class="m-card-title">登录</div>
      <div class="m-row">
        <input class="m-input" id="pwd" type="password" placeholder="管理密码"/>
        <button class="m-btn" id="btnLogin">登录</button>
      </div>
      <div class="m-hint" id="loginMsg"></div>
    </section>

    <section class="m-card hidden" id="panel">
      <div class="m-bar">
        <div class="m-row">
          <input class="m-input" id="q" placeholder="搜索（可选，按 PICUI）"/>
          <button class="m-btn" id="btnLoad">刷新</button>
          <button class="m-btn danger" id="btnBulk">批量删除</button>
          <button class="m-btn ghost" id="btnLogout">退出</button>
        </div>
        <div class="m-meta">
          <span class="pill" id="gistInfo"></span>
          <span class="pill">一致性：仅 PICUI 删除成功才删 Gist</span>
        </div>
      </div>

      <div class="m-table-wrap">
        <table class="m-table">
          <thead>
            <tr>
              <th style="width:52px;">选</th>
              <th style="width:140px;">预览</th>
              <th>URL</th>
              <th style="width:220px;">PICUI Key</th>
              <th style="width:220px;">Json 对应</th>
              <th style="width:120px;">操作</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="m-foot">
        点击背景可换图；Shift+点击任意位置也可换图。
      </div>
    </section>
  </main>

<script>
  const BG_API = "{{ bg_api }}";
  const bg = document.getElementById("mBg");
  function setBg(){
    const u = BG_API.includes("?") ? (BG_API + "&t=" + Date.now()) : (BG_API + "?t=" + Date.now());
    bg.style.backgroundImage = `url("${u}")`;
  }
  setBg();
  document.getElementById("btnBg").onclick = setBg;
  bg.addEventListener("click", setBg);
  window.addEventListener("click", (e)=>{ if(e.shiftKey) setBg(); });

  const loginCard = document.getElementById("loginCard");
  const panel = document.getElementById("panel");
  const rows = document.getElementById("rows");
  const gistInfo = document.getElementById("gistInfo");

  let currentItems = [];

  async function login(){
    const password = document.getElementById("pwd").value;
    const r = await fetch("/api/admin/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ password })
    });
    const j = await r.json().catch(()=>({ok:false,message:"bad json"}));
    const msg = document.getElementById("loginMsg");
    if(!j.ok){
      msg.textContent = j.message || "登录失败";
      msg.className = "m-hint bad";
      return;
    }
    msg.textContent = "";
    loginCard.classList.add("hidden");
    panel.classList.remove("hidden");
    await loadImages();
  }

  async function logout(){
    await fetch("/api/admin/logout", {method:"POST"});
    location.reload();
  }

  function getSelected(){
    return Array.from(document.querySelectorAll("input[data-idx]"))
      .filter(x=>x.checked)
      .map(x=>currentItems[Number(x.dataset.idx)]);
  }

  function render(items, stats){
    rows.innerHTML = "";
    currentItems = items || [];
    gistInfo.textContent = stats ? `Gist icons: ${stats.count}` : "";

    currentItems.forEach((it, idx)=>{
      const tr = document.createElement("tr");
      const jsonCell = it.in_gist
        ? `<span class="tag ok">已收录</span><div class="mini">name: ${it.icon_name || ""}</div>`
        : `<span class="tag bad">未收录</span>`;

      tr.innerHTML = `
        <td><input class="chk" type="checkbox" data-idx="${idx}"/></td>
        <td>${it.url ? `<img class="thumb" src="${it.url}" alt="img"/>` : ""}</td>
        <td>${it.url ? `<a class="a" href="${it.url}" target="_blank">${it.url}</a>` : ""}</td>
        <td class="mono">${it.key || ""}</td>
        <td>${jsonCell}</td>
        <td><button class="m-btn tiny danger" data-del="${idx}">删除</button></td>
      `;
      rows.appendChild(tr);
    });

    rows.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.onclick = async ()=>{
        const idx = Number(btn.dataset.del);
        const it = currentItems[idx];
        if(!it) return;
        if(!confirm("确认删除？（先删 PICUI；仅成功才从 icons.json 移除）")) return;
        await doDelete([it]);
      };
    });
  }

  async function loadImages(){
    const q = document.getElementById("q").value || "";
    const r = await fetch("/api/admin/images?q=" + encodeURIComponent(q));
    if(r.status === 401){
      alert("未登录或登录过期");
      location.reload();
      return;
    }
    const j = await r.json();
    if(!j.ok){
      alert(j.message || "加载失败");
      return;
    }
    render(j.items, j.gist_stats);
  }

  async function doDelete(items){
    const payload = { items: items.map(x=>({key:x.key, url:x.url})) };
    const r = await fetch("/api/admin/delete", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
    });
    const j = await r.json();
    if(!j.ok){
      alert(j.message || "删除失败");
      return;
    }
    const failed = (j.picui || []).filter(x=>!x.ok);
    const gist = j.gist || {};
    let msg = "";
    if(failed.length){
      msg += `PICUI 删除失败 ${failed.length} 个（不会从 icons.json 移除）：\n` +
        failed.map(x=>`${x.key}: ${x.error}`).join("\n") + "\n\n";
    }
    if(typeof gist.removed === "number"){
      msg += `icons.json 移除 ${gist.removed} 条（before=${gist.before}, after=${gist.after}）`;
    }
    if(msg) alert(msg);
    await loadImages();
  }

  async function bulkDelete(){
    const selected = getSelected();
    if(!selected.length){
      alert("请先勾选要删除的图片");
      return;
    }
    if(!confirm(`确认批量删除 ${selected.length} 张？`)) return;
    await doDelete(selected);
  }

  document.getElementById("btnLogin").onclick = login;
  document.getElementById("btnLogout").onclick = logout;
  document.getElementById("btnLoad").onclick = loadImages;
  document.getElementById("btnBulk").onclick = bulkDelete;
  document.getElementById("pwd").addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });
</script>
</body>
</html>
